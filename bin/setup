#!/bin/bash

set -e

mitamae_version="1.13.0"
mitamae_bin="mitamae-x86_64-linux"
mitamae_sha256="0c69f62b0019ea5d1029dc71e6dd7051992efebf97b088ba57e981e44d05a0c6"

mitamae_cache="mitamae-${mitamae_version}"
if ! [ -f "bin/${mitamae_cache}" ]; then
  curl -o "bin/${mitamae_bin}.tar.gz" -fL "https://github.com/itamae-kitchen/mitamae/releases/download/v${mitamae_version}/${mitamae_bin}.tar.gz"
  sha256="$(sha256sum "bin/${mitamae_bin}.tar.gz" | cut -d" " -f1)"
  if [ "$mitamae_sha256" != "$sha256" ]; then
    echo "checksum verification failed!\nexpected: ${mitamae_sha256}\n  actual: ${sha256}"
    exit 1
  fi
  tar xvzf "bin/${mitamae_bin}.tar.gz"

  rm "bin/${mitamae_bin}.tar.gz"
  mv "${mitamae_bin}" "bin/${mitamae_cache}"
  chmod +x "bin/${mitamae_cache}"
fi
ln -sf "${mitamae_cache}" bin/mitamae
